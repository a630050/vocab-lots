<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è©å½™æŠ½ç±¤è¡¨</title>
  <style>
    :root {
      --bg1: #fde7f3;
      --bg2: #e8f0ff;
      --card: #ffffff;
      --shadow: 0 16px 40px rgba(33, 19, 66, .12);
      --shadow2: 0 10px 24px rgba(33, 19, 66, .10);
      --text: #2a2240;
      --muted: #6c648a;
      --pri1: #ff4aa6;
      --pri2: #6d3cff;
      --pri3: #8c52ff;
      --good: #23a26d;
      --bad: #e24a4a;
      --line: rgba(37, 23, 68, .10);
      --chip: #f5f2ff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 500px at 20% 0%, var(--bg1) 0%, rgba(253, 231, 243, 0) 60%),
        radial-gradient(900px 500px at 80% 20%, var(--bg2) 0%, rgba(232, 240, 255, 0) 60%),
        linear-gradient(180deg, #f7f2ff 0%, #f6f7ff 60%, #ffffff 100%);
      min-height: 100vh;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 18px 70px;
    }

    header {
      text-align: center;
      padding: 12px 0 18px;
    }

    header h1 {
      margin: 0 0 6px;
      font-size: clamp(22px, 3.5vw, 40px);
      letter-spacing: .5px;
      color: #6a2bbf;
      font-weight: 900;
      text-shadow: 0 2px 0 rgba(255, 255, 255, .7);
    }

    header .sub {
      color: #7b53c6;
      font-weight: 700;
      opacity: .9;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 16px;
      align-items: start;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    /* å´é‚Šæ¬„æ¨£å¼ */
    .sidebar {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;

      height: 100vh;
      background: var(--card);
      box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      transition: right 0.3s ease;
      overflow-y: auto;
      padding: 20px;
      border-left: 1px solid rgba(59, 43, 106, 0.1);
    }

    .sidebar.open {
      right: 0;
    }

    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      z-index: 999;
      display: none;
    }

    .sidebar-overlay.show {
      display: block;
    }

    .toggle-sidebar {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1001;
      background: var(--pri2);
      color: white;
      border: none;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .btn-help {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1001;
      background: #6c648a;
      color: white;
      border: none;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      font-weight: 900;
      font-size: 20px;
    }

    .grid {
      display: block;
      max-width: 800px;
      margin: 0 auto;
    }

    .card {
      background: var(--card);
      border-radius: 18px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 255, 255, .7);
    }

    .card-inner {
      padding: 18px;
    }

    .titleRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .secTitle {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 900;
      color: #3b2b6a;
    }

    .secTitle small {
      color: var(--muted);
      font-weight: 700;
    }

    .btn {
      border: 0;
      cursor: pointer;
      border-radius: 999px;
      padding: 12px 16px;
      font-weight: 900;
      font-size: 14px;
      color: white;
      background: linear-gradient(90deg, var(--pri1), var(--pri2));
      box-shadow: 0 10px 22px rgba(109, 60, 255, .24);
      transition: transform .08s ease, filter .2s ease, opacity .2s ease;
      user-select: none;
    }

    .btn:active {
      transform: translateY(1px) scale(.99);
    }

    .btn.secondary {
      background: #f3efff;
      color: #3b2b6a;
      box-shadow: none;
      border: 1px solid rgba(59, 43, 106, .16);
    }

    .btn.ghost {
      background: transparent;
      color: #3b2b6a;
      box-shadow: none;
      border: 1px dashed rgba(59, 43, 106, .28);
    }

    .btn.small {
      padding: 10px 12px;
      font-size: 13px;
    }

    .btn.danger {
      background: linear-gradient(90deg, #ff5a5a, #ff2f7e);
    }

    .btn.good {
      background: linear-gradient(90deg, #20c58f, #1b9a69);
    }

    .btn.bad {
      background: linear-gradient(90deg, #ff6a6a, #d83d3d);
    }

    .btn.warning {
      background: linear-gradient(90deg, #ff9500, #ff6b00);
    }

    .btn:disabled {
      opacity: .55;
      cursor: not-allowed;
      filter: saturate(.6);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: #f6f2ff;
      border: 1px solid rgba(59, 43, 106, .12);
      color: #3b2b6a;
      font-weight: 900;
    }

    .muted {
      color: var(--muted);
    }

    .bigCenter {
      min-height: 240px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 12px;
      padding: 20px 10px 14px;
    }

    .dice {
      width: 92px;
      height: 92px;
      display: grid;
      place-items: center;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #ff68b9, #6d3cff);
      box-shadow: 0 18px 30px rgba(109, 60, 255, .25);
      margin-bottom: 2px;
      transition: transform 0.1s ease-out;
    }

    .dice span {
      font-size: 40px;
      filter: drop-shadow(0 2px 0 rgba(0, 0, 0, .12));
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 10px;
    }

    @media (max-width: 600px) {
      .stats {
        grid-template-columns: 1fr 1fr;
      }
    }

    .statBox {
      border-radius: 14px;
      padding: 14px 12px;
      border: 1px solid rgba(59, 43, 106, .10);
      background: linear-gradient(180deg, #fbf9ff, #ffffff);
      text-align: center;
    }

    .statNum {
      font-weight: 1000;
      color: #6d3cff;
      font-size: 26px;
      line-height: 1.1;
    }

    .statNum.good {
      color: var(--good);
    }

    .statNum.bad {
      color: var(--bad);
    }

    .statLab {
      font-weight: 900;
      color: var(--muted);
      font-size: 12px;
      margin-top: 6px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }

    .field label {
      font-weight: 900;
      color: #3b2b6a;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(59, 43, 106, .18);
      outline: none;
      font-weight: 800;
      font-size: 14px;
      color: #2a2240;
      background: #fff;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: rgba(109, 60, 255, .55);
      box-shadow: 0 0 0 4px rgba(109, 60, 255, .12);
    }

    .adminRow {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }

    .warn {
      padding: 10px 12px;
      border-radius: 12px;
      background: #fff6f6;
      border: 1px solid rgba(226, 74, 74, .25);
      color: #9a2f2f;
      font-weight: 800;
      margin-bottom: 12px;
    }

    .success {
      padding: 10px 12px;
      border-radius: 12px;
      background: #f0fff6;
      border: 1px solid rgba(35, 162, 109, .25);
      color: #1a6b47;
      font-weight: 800;
      margin-bottom: 12px;
    }

    .qWrap {
      padding-top: 10px;
    }

    .qHead {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .qMeta {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .qMeta .k {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 10px;
      border-radius: 999px;
      background: var(--chip);
      border: 1px solid rgba(109, 60, 255, .16);
      font-weight: 900;
      color: #3b2b6a;
      font-size: 12px;
    }

    .qBox {
      border-radius: 16px;
      border: 1px solid rgba(59, 43, 106, .10);
      background: linear-gradient(180deg, #fbfaff, #ffffff);
      padding: 14px 14px 12px;
    }

    .word {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-end;
      justify-content: center;
      padding: 20px 2px;
    }

    .char {
      position: relative;
      display: inline-flex;
      align-items: flex-end;
      gap: 4px;
    }

    .hz {
      font-size: clamp(48px, 6vw, 72px);
      font-weight: 950;
      letter-spacing: 1px;
      color: #3b2b6a;
      line-height: 1;
    }

    .zy {
      display: flex;
      flex-direction: column;
      font-size: 24px;
      /* åŠ å¤§æ³¨éŸ³ */
      font-weight: 900;
      color: #6d3cff !important;
      line-height: 1;
      transform: translateY(-5px);
      white-space: nowrap;
      position: relative;
      min-width: 30px;
      min-height: 40px;
    }

    .zy span {
      display: block;
      text-align: center;
    }

    .zy .tone {
      position: absolute;
      right: -15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
    }

    .zy.missing {
      color: #9a95aa;
    }


    .qActions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
      justify-content: center;
    }

    .answerArea {
      margin-top: 12px;
      border-radius: 14px;
      border: 1px dashed rgba(59, 43, 106, .22);
      background: #ffffff;
      padding: 12px;
      display: none;
    }

    .answerArea.show {
      display: block;
    }

    .answerImg {
      width: 100%;
      max-height: 380px;
      object-fit: contain;
      border-radius: 12px;
      background: #f7f6ff;
      border: 1px solid rgba(59, 43, 106, .10);
    }

    .answerCap {
      margin-top: 10px;
      font-weight: 900;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 13px;
    }

    .list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px 0 2px;
    }

    .chip {
      border-radius: 14px;
      background: #fff;
      border: 1px solid rgba(59, 43, 106, .12);
      box-shadow: var(--shadow2);
      padding: 10px 12px;
      min-width: 120px;
      cursor: pointer;
      transition: transform .08s ease, border-color .2s ease;
    }

    .chip:hover {
      border-color: rgba(109, 60, 255, .30);
    }

    .chip:active {
      transform: translateY(1px);
    }

    .chipTop {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .chipWord {
      font-weight: 1000;
      color: #3b2b6a;
      font-size: 15px;
    }

    .chipState {
      font-weight: 1000;
      font-size: 11px;
    }

    .chipState.good {
      color: var(--good);
    }

    .chipState.bad {
      color: var(--bad);
    }

    .chipState.neu {
      color: #9a95aa;
    }

    .chipSub {
      color: var(--muted);
      font-weight: 800;
      font-size: 11px;
      line-height: 1.35;
    }

    .bookItem {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-radius: 12px;
      background: #f9f7ff;
      border: 1px solid rgba(59, 43, 106, .10);
      margin-bottom: 8px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .bookItem .name {
      font-weight: 900;
      color: #3b2b6a;
    }

    .bookItem .info {
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }

    .bookItem .actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .hr {
      height: 1px;
      background: rgba(59, 43, 106, .10);
      margin: 14px 0;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(38, 26, 78, .92);
      color: white;
      padding: 10px 16px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 13px;
      display: none;
      z-index: 60;
    }

    .toast.show {
      display: block;
    }

    .empty {
      text-align: center;
      padding: 30px 10px;
      color: var(--muted);
      font-weight: 700;
    }

    .tabRow {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 10px 14px;
      border-radius: 999px;
      background: #f3efff;
      border: 1px solid rgba(59, 43, 106, .12);
      font-weight: 900;
      color: #3b2b6a;
      cursor: pointer;
      transition: all .15s ease;
    }

    .tab:hover {
      background: #ebe5ff;
    }

    .tab.active {
      background: linear-gradient(90deg, var(--pri1), var(--pri2));
      color: white;
      border-color: transparent;
    }

    .scrollBox {
      max-height: 320px;
      overflow-y: auto;
    }

    .resetBtnGroup {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Modal æ¨£å¼ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, .5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;

    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 20px;
      padding: 24px;
      max-width: 80%
        /* è®Šå¯¬ä¸€é» */
      ;
      width: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .3);
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
      color: var(--muted);
      font-weight: bold;
    }

    .modal-img-container {
      text-align: center;
    }

    .modal-img {
      max-width: 85%;
      max-height: 75vh;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      border: 4px solid white;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 900;
      color: #3b2b6a;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-body {
      color: var(--muted);
      font-weight: 700;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>ğŸ‘‘ è©å½™æŠ½ç±¤è¡¨ ğŸ‘‘</h1>
    </header>

    <button class="btn-help" id="btnHelp" title="ä½¿ç”¨èªªæ˜">â“</button>
    <button class="toggle-sidebar" id="btnToggleSidebar" title="å¾Œå°è¨­å®š">âš™ï¸</button>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>


    <div class="grid">
      <!-- å·¦å´ï¼šä¸»å€ -->
      <section>

        <!-- æ›¸åº«é¸æ“‡ -->
        <div class="card" style="margin-bottom: 16px;">
          <div class="card-inner">
            <div class="titleRow">
              <div class="secTitle">ğŸ“š é¸æ“‡æ›¸åº«</div>
            </div>
            <div class="field" style="margin-bottom: 0;">
              <select id="selBook">
                <option value="">-- è«‹å…ˆæ–°å¢æ›¸åº« --</option>
              </select>
            </div>
          </div>
        </div>

        <!-- æŠ½ç±¤å€ -->
        <div class="card">
          <div class="card-inner">
            <div class="bigCenter" id="heroArea">
              <div class="dice"><span>ğŸ²</span></div>
              <button class="btn" id="btnDraw" disabled>ğŸ¯ é–‹å§‹æŠ½ç±¤</button>
              <div class="hint" id="heroHint">è«‹å…ˆåœ¨å³å´ã€Œå¾Œå°ç®¡ç†ã€æ–°å¢æ›¸åº«ä¸¦ç¶å®šè³‡æ–™å¤¾ã€‚</div>
            </div>

            <!-- æŠ½ç±¤çµæœå€å¡Š -->
            <div id="questionArea" style="display:none; border-top: 1px solid var(--line); padding-top: 20px;">
              <div class="qMeta" style="margin-bottom: 15px;">
                <div class="k">
                  <span class="badge" id="qBookName">ğŸ“š æ›¸åº«</span>
                  <span class="badge" id="qIndex">ğŸ¯ ç¬¬ 1 é¡Œ</span>
                </div>
              </div>

              <div class="qBox"
                style="background: #fff; border-radius: 16px; padding: 25px 15px; border: 1px solid rgba(59,43,106,0.1); margin-bottom: 20px;">
                <div id="wordDisplay" class="word"></div>
              </div>

              <div class="qActions">
                <button class="btn" id="btnDrawNext"
                  style="background: linear-gradient(90deg, #ff9a9e, #fad0c4); color: #333;">ğŸ² æŠ½ä¸‹ä¸€å€‹</button>
                <button class="btn" id="btnShowAns">ğŸ‘€ é¡¯ç¤ºç­”æ¡ˆ</button>
                <div style="display: flex; gap: 8px;">
                  <button class="btn good small" id="btnCorrect">âœ… ç­”å°</button>
                  <button class="btn bad small" id="btnWrong">âŒ ç­”éŒ¯</button>
                </div>
              </div>
            </div>




            <!-- çµ±è¨ˆ -->
            <div class="hr"></div>
            <div class="titleRow">
              <div class="secTitle">ğŸ“Š çµ±è¨ˆ</div>
              <div class="resetBtnGroup">
                <button class="btn small secondary" id="btnReset">ğŸ”„ é‡ç½®æœ¬æ›¸åº«</button>
              </div>
            </div>
            <div class="stats">
              <div class="statBox">
                <div class="statNum" id="statTotal">0</div>
                <div class="statLab">ç¸½é¡Œæ•¸</div>
              </div>
              <div class="statBox">
                <div class="statNum" id="statDrawn">0</div>
                <div class="statLab">å·²æŠ½</div>
              </div>
              <div class="statBox">
                <div class="statNum good" id="statCorrect">0</div>
                <div class="statLab">ç­”å°</div>
              </div>
              <div class="statBox">
                <div class="statNum bad" id="statWrong">0</div>
                <div class="statLab">ç­”éŒ¯</div>
              </div>
            </div>
          </div>
        </div>

        <!-- æ­·å²æ¸…å–® -->
        <div class="card" style="margin-top: 16px;">
          <div class="card-inner">
            <div class="titleRow">
              <div class="secTitle">ğŸ“ å·²æŠ½æ¸…å–® <small id="historyCount">(0)</small></div>
              <div class="tabRow" style="margin-bottom: 0;">
                <span class="tab active" data-filter="all">å…¨éƒ¨</span>
                <span class="tab" data-filter="wrong">âŒ éŒ¯é¡Œ</span>
              </div>
            </div>
            <div class="scrollBox">
              <div class="list" id="historyList">
                <div class="empty">å°šæœªæŠ½éä»»ä½•é¡Œç›®</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      </section>

      <!-- å³å´ï¼šå¾Œå°ç®¡ç† (ç¾åœ¨è¢«åŒ…åœ¨ sidebar å…§) -->
      <section class="sidebar" id="sidebar">
        <div class="card">
          <div class="card-inner">
            <div class="titleRow">
              <div class="secTitle">âš™ï¸ å¾Œå°ç®¡ç†</div>
            </div>

            <div class="field">
              <label>ğŸ“– æ–°å¢æ›¸åº«åç¨±</label>
              <input type="text" id="inputBookName" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€å†Šã€å‹•ç‰©ç¯‡..." />
            </div>
            <div class="field">
              <label>ğŸ“ ç¶å®šè³‡æ–™å¤¾ï¼ˆé¸æ“‡å¾Œè‡ªå‹•æƒæåœ–ç‰‡ï¼‰</label>
              <button class="btn secondary" id="btnSelectFolder">ğŸ“‚ é¸æ“‡è³‡æ–™å¤¾</button>
              <div class="hint" id="folderHint">å°šæœªé¸æ“‡è³‡æ–™å¤¾</div>
            </div>
            <button class="btn" id="btnAddBook" disabled>â• æ–°å¢æ›¸åº«</button>

            <div class="hr"></div>

            <div class="titleRow">
              <div class="secTitle">ğŸ“š å·²å»ºç«‹çš„æ›¸åº«</div>
            </div>
            <div id="bookList">
              <div class="empty">å°šæœªå»ºç«‹ä»»ä½•æ›¸åº«</div>
            </div>

            <div class="hr"></div>

            <!-- å…¨åŸŸé‡ç½®å€å¡Š -->
            <div class="titleRow">
              <div class="secTitle">ğŸ”§ ç³»çµ±ç®¡ç†</div>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 14px;">
              <button class="btn small warning" id="btnResetAllRecords">ğŸ”„ é‡ç½®æ‰€æœ‰æŠ½ç±¤ç´€éŒ„</button>
              <button class="btn small danger" id="btnResetAll">ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨è³‡æ–™</button>
            </div>

            <div class="hr"></div>
            <div class="hint">
              ğŸ’¡ <b>ä½¿ç”¨èªªæ˜ï¼š</b><br>
              1. è¼¸å…¥æ›¸åº«åç¨±<br>
              2. é»ã€Œé¸æ“‡è³‡æ–™å¤¾ã€ç¶å®šåœ–ç‰‡è³‡æ–™å¤¾<br>
              3. ç³»çµ±è‡ªå‹•æƒæåœ–ç‰‡ï¼Œæª”åå³ç‚ºé¡Œç›®<br>
              4. åˆ‡æ›æ›¸åº«å¾Œå³å¯é–‹å§‹æŠ½ç±¤<br>
              5. æ³¨éŸ³æœƒè‡ªå‹•å¾èŒå…¸ API æŸ¥è©¢<br><br>
              ğŸ”„ <b>é‡ç½®åŠŸèƒ½ï¼š</b><br>
              â€¢ é‡ç½®æœ¬æ›¸åº«ï¼šæ¸…ç©ºç•¶å‰æ›¸åº«çš„æŠ½ç±¤ç´€éŒ„<br>
              â€¢ é‡ç½®æ‰€æœ‰æŠ½ç±¤ç´€éŒ„ï¼šä¿ç•™æ›¸åº«ï¼Œæ¸…ç©ºæ‰€æœ‰ç´€éŒ„<br>
              â€¢ æ¸…ç©ºå…¨éƒ¨è³‡æ–™ï¼šåˆªé™¤æ‰€æœ‰æ›¸åº«å’Œç´€éŒ„
            </div>
          </div>
        </div>
      </section>
    </div>

  </div>

  <div class="toast" id="toast"></div>

  <!-- ç¢ºèªå°è©±æ¡† Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <span class="modal-close" id="modalClose">&times;</span>
      <div class="modal-title" id="modalTitle">âš ï¸ ç¢ºèªæ“ä½œ</div>
      <div class="modal-body" id="modalBody">ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</div>
      <div class="modal-actions" id="modalActions">
        <button class="btn secondary" id="modalCancel">å–æ¶ˆ</button>
        <button class="btn danger" id="modalConfirm">ç¢ºèª</button>
      </div>
    </div>
  </div>


  <script>
    // ========== è³‡æ–™çµæ§‹ ==========
    let books = {}; // { bookName: { files: [{name, dataUrl}], drawn: [], history: [] } }
    let currentBook = '';
    let currentQuestion = null;
    let selectedFiles = [];
    let zhuyinCache = {};
    let historyFilter = 'all';
    let modalCallback = null;

    // ========== DOM ==========
    const $ = id => document.getElementById(id);
    const selBook = $('selBook');
    const btnDraw = $('btnDraw');
    const heroArea = $('heroArea');
    const heroHint = $('heroHint');
    const questionArea = $('questionArea');
    const wordDisplay = $('wordDisplay');
    const answerArea = $('answerArea');
    const answerImg = $('answerImg');
    const answerFileName = $('answerFileName');
    const qBookName = $('qBookName');
    const qIndex = $('qIndex');
    const btnShowAns = $('btnShowAns');
    const btnDrawNext = $('btnDrawNext');
    const btnToggleSidebar = $('btnToggleSidebar');
    const sidebar = $('sidebar');
    const sidebarOverlay = $('sidebarOverlay');

    const btnCorrect = $('btnCorrect');
    const btnWrong = $('btnWrong');
    const btnNext = $('btnNext');
    const btnReset = $('btnReset');
    const statTotal = $('statTotal');
    const statDrawn = $('statDrawn');
    const statCorrect = $('statCorrect');
    const statWrong = $('statWrong');
    const historyList = $('historyList');
    const historyCount = $('historyCount');
    const inputBookName = $('inputBookName');
    const btnSelectFolder = $('btnSelectFolder');
    const folderHint = $('folderHint');
    const btnAddBook = $('btnAddBook');
    const btnHelp = $('btnHelp');
    const bookList = $('bookList');
    const toast = $('toast');
    const btnResetAllRecords = $('btnResetAllRecords');
    const btnResetAll = $('btnResetAll');
    const modalActions = $('modalActions');
    const modalClose = $('modalClose');
    const modalOverlay = $('modalOverlay');
    const modalTitle = $('modalTitle');
    const modalBody = $('modalBody');
    const modalCancel = $('modalCancel');
    const modalConfirm = $('modalConfirm');


    // ========== Modal ç¢ºèªå°è©±æ¡† ==========
    function showModal(title, body, confirmText, isDanger, callback, hideCancel = false) {
      modalTitle.innerHTML = title;
      modalBody.innerHTML = body;

      if (confirmText === null) {
        modalActions.style.display = 'none';
      } else {
        modalActions.style.display = 'flex';
        modalConfirm.textContent = confirmText || 'ç¢ºèª';
        modalConfirm.className = isDanger ? 'btn danger' : 'btn';
        modalCancel.style.display = hideCancel ? 'none' : 'block';
      }

      modalCallback = callback;
      modalOverlay.classList.add('show');
    }


    function hideModal() {
      modalOverlay.classList.remove('show');
      modalCallback = null;
    }

    modalCancel.onclick = hideModal;
    modalConfirm.onclick = () => {
      if (modalCallback) modalCallback();
      hideModal();
    };
    modalOverlay.onclick = (e) => {
      if (e.target === modalOverlay) hideModal();
    };

    // ========== Toast ==========
    function showToast(msg, duration = 2000) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    // ========== IndexedDB ç®¡ç† ==========
    const DB_NAME = 'DrawLotsDB';
    const STORE_NAME = 'BooksStore';
    let db;

    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 2);
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME);
          }
        };
        request.onsuccess = (e) => {
          db = e.target.result;
          resolve();
        };
        request.onerror = (e) => reject(e);
      });
    }

    async function dbPut(key, val) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        const request = store.put(val, key);
        request.onsuccess = () => resolve();
        request.onerror = () => reject();
      });
    }

    async function dbGet(key) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const request = store.get(key);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject();
      });
    }

    async function saveData() {
      const saveBooks = {};
      for (const [name, book] of Object.entries(books)) {
        saveBooks[name] = {
          files: book.files, // å„²å­˜å®Œæ•´ç‰©ä»¶ï¼ˆå« dataUrlï¼‰
          drawn: book.drawn,
          history: book.history
        };
      }
      try {
        await dbPut('books', saveBooks);
        localStorage.setItem('drawLots_currentBook', currentBook);
        localStorage.setItem('drawLots_zhuyinCache', JSON.stringify(zhuyinCache));
      } catch (e) {
        console.error('å„²å­˜å¤±æ•—', e);
      }
    }

    async function loadData() {
      try {
        await initDB();
        const savedBooks = await dbGet('books') || {};
        const savedCurrent = localStorage.getItem('drawLots_currentBook') || '';
        const savedCache = JSON.parse(localStorage.getItem('drawLots_zhuyinCache') || '{}');

        zhuyinCache = savedCache;
        books = savedBooks;
        currentBook = savedCurrent;

        // å¦‚æœ localStorage é‚„æœ‰èˆŠæ ¼å¼çš„è³‡æ–™ï¼Œå¯ä»¥è€ƒæ…®é·ç§»ï¼Œä½†é€™è£¡æˆ‘å€‘å…ˆä»¥æ–°æ ¼å¼ç‚ºä¸»
      } catch (e) {
        console.error('è¼‰å…¥è³‡æ–™å¤±æ•—', e);
      }
    }

    // ========== èŒå…¸ API ==========
    async function getZhuyin(word) {
      if (!word) return [];

      // å˜—è©¦æ•´è©æŸ¥è©¢ä»¥å„ªåŒ–ç ´éŸ³å­—
      try {
        const res = await fetch(`https://www.moedict.tw/uni/${encodeURIComponent(word)}`);
        if (res.ok) {
          const data = await res.json();
          if (data.heteronyms && data.heteronyms[0] && data.heteronyms[0].bopomofo) {
            const fullZy = data.heteronyms[0].bopomofo;
            // èŒå…¸è©å½™æ³¨éŸ³é€šå¸¸ä»¥ç©ºæ ¼åˆ†éš”ï¼Œä¾‹å¦‚ "ã„’ã„§ã„ Ë‡ ã„’ã„©ã„ËŠ"
            const parts = fullZy.trim().split(/\s+/);
            if (parts.length === word.length) {
              return parts;
            }
          }
        }
      } catch (e) {
        console.warn('æ•´è©æŸ¥è©¢å¤±æ•—ï¼Œåˆ‡æ›è‡³å–®å­—æŸ¥è©¢', e);
      }

      // å¦‚æœæ•´è©æŸ¥è©¢å¤±æ•—æˆ–é•·åº¦ä¸ç¬¦ï¼Œå‰‡å›é€€è‡³é€å­—æŸ¥è©¢
      const results = [];
      for (const char of word) {
        if (zhuyinCache[char]) {
          results.push(zhuyinCache[char]);
          continue;
        }
        try {
          const res = await fetch(`https://www.moedict.tw/uni/${encodeURIComponent(char)}`);
          if (res.ok) {
            const data = await res.json();
            if (data.heteronyms && data.heteronyms[0] && data.heteronyms[0].bopomofo) {
              const zy = data.heteronyms[0].bopomofo.replace(/[Ë™ËŠË‡Ë‹\s]/g, m => m);
              zhuyinCache[char] = zy;
              results.push(zy);
            } else {
              results.push('');
            }
          } else {
            results.push('');
          }
        } catch (e) {
          console.error('æŸ¥è©¢æ³¨éŸ³å¤±æ•—', char, e);
          results.push('');
        }
      }
      saveData();
      return results;
    }


    async function prefetchZhuyin(bookName) {
      if (!books[bookName]) return;
      const files = books[bookName].files;
      for (const file of files) {
        if (!zhuyinCache[file.name]) {
          await getZhuyin(file.name);
        }
      }
    }

    // ========== æ³¨éŸ³æ‹†åˆ†é¡¯ç¤º ==========
    function splitZhuyin(zy) {
      const tones = ['Ë™', 'ËŠ', 'Ë‡', 'Ë‹'];
      let main = [];
      let tone = '';
      for (const c of zy) {
        if (tones.includes(c)) {
          tone = c;
        } else {
          main.push(c);
        }
      }
      return { main, tone };
    }


    // ========== æ¸²æŸ“é¡Œç›® ==========
    async function renderQuestion(q) {
      if (!q || !q.name) return;
      const display = document.getElementById('wordDisplay');
      if (!display) return;

      display.innerHTML = '';
      const chars = q.name.split('');

      chars.forEach((char, i) => {
        const charEl = document.createElement('div');
        charEl.className = 'char';

        const hzEl = document.createElement('span');
        hzEl.className = 'hz';
        hzEl.textContent = char;

        const zyEl = document.createElement('div');
        zyEl.className = 'zy';
        zyEl.id = `zy-char-${i}`;

        if (zhuyinCache[char]) {
          const { main, tone } = splitZhuyin(zhuyinCache[char]);
          main.forEach(c => {
            const s = document.createElement('span');
            s.textContent = c;
            zyEl.appendChild(s);
          });
          if (tone) {
            const ts = document.createElement('span');
            ts.className = 'tone';
            ts.textContent = tone;
            zyEl.appendChild(ts);
          }
        } else {
          zyEl.textContent = '...';
        }

        charEl.appendChild(hzEl);
        charEl.appendChild(zyEl);
        display.appendChild(charEl);
      });

      // éåŒæ­¥æ›´æ–°
      getZhuyin(q.name).then(list => {
        q.zhuyin = list;
        chars.forEach((char, i) => {
          const zy = list[i];
          const zyEl = document.getElementById(`zy-char-${i}`);
          if (zy && zyEl && (zyEl.textContent === '...' || zyEl.innerHTML === '')) {
            zyEl.innerHTML = '';
            const { main, tone } = splitZhuyin(zy);
            main.forEach(c => {
              const s = document.createElement('span');
              s.textContent = c;
              zyEl.appendChild(s);
            });
            if (tone) {
              const ts = document.createElement('span');
              ts.className = 'tone';
              ts.textContent = tone;
              zyEl.appendChild(ts);
            }
          } else if (!zy && zyEl && zyEl.textContent === '...') {
            zyEl.textContent = '?';
          }
        });
      }).catch(err => {
        console.error(err);
        chars.forEach((_, i) => {
          const zyEl = document.getElementById(`zy-char-${i}`);
          if (zyEl && zyEl.textContent === '...') zyEl.textContent = '?';
        });
      });
    }



    // ========== æ›´æ–°çµ±è¨ˆ ==========
    function updateStats() {
      if (!currentBook || !books[currentBook]) {
        statTotal.textContent = '0';
        statDrawn.textContent = '0';
        statCorrect.textContent = '0';
        statWrong.textContent = '0';
        return;
      }
      const book = books[currentBook];
      statTotal.textContent = book.files.length;
      statDrawn.textContent = book.drawn.length;
      const correct = book.history.filter(h => h.state === 'correct').length;
      const wrong = book.history.filter(h => h.state === 'wrong').length;
      statCorrect.textContent = correct;
      statWrong.textContent = wrong;
    }

    // ========== æ›´æ–°æ­·å²æ¸…å–® ==========
    function updateHistory() {
      if (!currentBook || !books[currentBook]) {
        historyList.innerHTML = '<div class="empty">å°šæœªæŠ½éä»»ä½•é¡Œç›®</div>';
        historyCount.textContent = '(0)';
        return;
      }
      const book = books[currentBook];
      let list = [...book.history].reverse();

      if (historyFilter === 'wrong') {
        list = list.filter(h => h.state === 'wrong');
      }

      historyCount.textContent = `(${book.history.length})`;

      if (list.length === 0) {
        historyList.innerHTML = '<div class="empty">' +
          (historyFilter === 'wrong' ? 'æ²’æœ‰éŒ¯é¡Œ' : 'å°šæœªæŠ½éä»»ä½•é¡Œç›®') + '</div>';
        return;
      }

      historyList.innerHTML = '';
      list.forEach((h, idx) => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.onclick = () => reviewQuestion(h);

        let stateClass = 'neu';
        let stateText = 'æœªä½œç­”';
        if (h.state === 'correct') { stateClass = 'good'; stateText = 'âœ… å°'; }
        else if (h.state === 'wrong') { stateClass = 'bad'; stateText = 'âŒ éŒ¯'; }

        chip.innerHTML = `
          <div class="chipTop">
            <span class="chipWord">${h.name}</span>
            <span class="chipState ${stateClass}">${stateText}</span>
          </div>
          <div class="chipSub">${h.showedAnswer ? 'å·²çœ‹ç­”æ¡ˆ' : 'æœªçœ‹ç­”æ¡ˆ'}</div>
        `;
        historyList.appendChild(chip);
      });
    }

    // ========== å›çœ‹é¡Œç›® ==========
    async function reviewQuestion(h) {
      const book = books[currentBook];
      const file = book.files.find(f => f.name === h.name);
      if (!file) {
        showToast('æ‰¾ä¸åˆ°è©²é¡Œç›®');
        return;
      }

      currentQuestion = { ...h, dataUrl: file.dataUrl };
      document.getElementById('heroArea').style.display = 'none';
      document.getElementById('questionArea').style.display = 'block';

      document.getElementById('qBookName').textContent = 'ğŸ“š ' + currentBook;
      const idx = book.history.findIndex(x => x.name === h.name);
      document.getElementById('qIndex').textContent = 'ğŸ¯ ç¬¬ ' + (idx + 1) + ' é¡Œï¼ˆå›çœ‹ï¼‰';

      await renderQuestion(currentQuestion);
      updateButtonStates();
    }

    // ========== æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ ==========
    function updateButtonStates() {
      if (!currentQuestion) return;
      const book = books[currentBook];
      const h = book.history.find(x => x.name === currentQuestion.name);
      if (h) {
        btnCorrect.disabled = h.state === 'correct';
        btnWrong.disabled = h.state === 'wrong';
      }
    }

    // ========== æŠ½ç±¤ ==========
    async function drawQuestion() {
      if (!currentBook || !books[currentBook]) {
        showToast('è«‹å…ˆé¸æ“‡æ›¸åº«');
        return;
      }

      const book = books[currentBook];

      const hasData = book.files.some(f => f.dataUrl);
      if (!hasData) {
        showToast('è«‹é‡æ–°ç¶å®šè³‡æ–™å¤¾ä»¥è¼‰å…¥åœ–ç‰‡');
        return;
      }

      const remaining = book.files.filter(f => !book.drawn.includes(f.name));
      if (remaining.length === 0) {
        showToast('æœ¬æ›¸åº«å·²å…¨éƒ¨æŠ½å®Œï¼');
        return;
      }

      const idx = Math.floor(Math.random() * remaining.length);
      const file = remaining[idx];

      book.drawn.push(file.name);
      const historyItem = {
        name: file.name,
        state: null,
        showedAnswer: false,
        zhuyin: []
      };
      book.history.push(historyItem);

      currentQuestion = { ...historyItem, dataUrl: file.dataUrl };

      document.getElementById('heroArea').style.display = 'none';
      document.getElementById('questionArea').style.display = 'block';

      document.getElementById('qBookName').textContent = 'ğŸ“š ' + currentBook;
      document.getElementById('qIndex').textContent = 'ğŸ¯ ç¬¬ ' + book.history.length + ' é¡Œ';

      await renderQuestion(currentQuestion);

      btnCorrect.disabled = false;
      btnWrong.disabled = false;

      updateStats();
      updateHistory();
      saveData();
    }

    // ========== æŠ½ç±¤å‹•ç•« ==========
    async function animateDraw() {
      // å¦‚æœç­”æ¡ˆè¦–çª—é–‹å•Ÿä¸­ï¼Œè‡ªå‹•é—œé–‰
      hideModal();

      // æ’­æ”¾æŠ½ç±¤éŸ³æ•ˆ
      const audioEl = document.getElementById('audioDraw');
      if (audioEl) {
        audioEl.currentTime = 0;
        audioEl.play().catch(e => console.warn('éŸ³æ•ˆæ’­æ”¾å¤±æ•—', e));
      }

      if (!currentBook || !books[currentBook]) {
        showToast('è«‹å…ˆé¸æ“‡æ›¸åº«');
        return;
      }
      const book = books[currentBook];
      const remaining = book.files.filter(f => !book.drawn.includes(f.name));
      if (remaining.length === 0) {
        showToast('æœ¬æ›¸åº«å·²å…¨éƒ¨æŠ½å®Œï¼');
        return;
      }

      // å›åˆ° heroArea ä¸¦é¡¯ç¤ºå‹•ç•«
      document.getElementById('heroArea').style.display = 'flex';
      document.getElementById('questionArea').style.display = 'none';

      const diceSpan = document.querySelector('#heroArea .dice span');
      const originalDice = diceSpan.textContent;

      // å‹•ç•«
      const animIcons = ['ğŸ²', 'ğŸ¯', 'ğŸ°', 'âœ¨', 'ğŸ‘‘', 'ğŸ”®'];
      const diceContainer = document.querySelector('#heroArea .dice');

      for (let i = 0; i < 15; i++) {
        diceSpan.textContent = animIcons[Math.floor(Math.random() * animIcons.length)];
        // å¾®å°çš„éš¨æ©Ÿæ—‹è½‰èˆ‡ç¸®æ”¾æ•ˆæœ
        diceContainer.style.transform = `scale(${1 + Math.random() * 0.1}) rotate(${Math.random() * 10 - 5}deg)`;
        await new Promise(r => setTimeout(r, 60));
      }
      diceContainer.style.transform = 'scale(1) rotate(0deg)';
      diceSpan.textContent = originalDice;

      await drawQuestion();
    }



    // ========== ä½¿ç”¨èªªæ˜ ==========
    function showHelp() {
      showModal(
        'ğŸ’¡ ç¨‹å¼ä½¿ç”¨èªªæ˜',
        `<div style="max-height: 70vh; overflow-y: auto; text-align: left; padding: 0 10px; line-height: 1.6; color: #4a4a4a;">
          <section style="margin-bottom: 20px;">
            <h3 style="color: var(--pri2); border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 10px;">ğŸ’¡ ç¨‹å¼æ¦‚è¦½</h3>
            <p>æœ¬ç¨‹å¼æ˜¯ä¸€å€‹é›¢ç·šå„ªå…ˆçš„è©å½™ç·´ç¿’å·¥å…·ã€‚æ‚¨å¯ä»¥å°‡æœ¬åœ°é›»è…¦çš„åœ–ç‰‡è³‡æ–™å¤¾ç¶å®šåˆ°æ›¸åº«ï¼Œç³»çµ±æœƒè‡ªå‹•æå–æª”åä½œç‚ºé¡Œç›®ï¼Œä¸¦å¾èŒå…¸ API æŸ¥è©¢æ³¨éŸ³ã€‚</p>
          </section>

          <section style="margin-bottom: 20px;">
            <h3 style="color: var(--pri2); border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 10px;">ğŸ“ æº–å‚™èˆ‡æ–°å¢æ›¸åº«</h3>
            <ol style="padding-left: 20px;">
              <li><b>æº–å‚™åœ–ç‰‡</b>ï¼šè«‹å°‡æ‚¨çš„è©å½™åœ–ç‰‡æ”¾å…¥è³‡æ–™å¤¾ä¸­ï¼Œ<b>æª”æ¡ˆåç¨±å³ç‚ºé¡Œç›®</b>ï¼ˆä¾‹å¦‚ï¼š<code>è˜‹æœ.jpg</code>, <code>é¦™è•‰.png</code>ï¼‰ã€‚</li>
              <li><b>å»ºç«‹æ›¸åº«</b>ï¼š
                <ul style="padding-left: 20px; margin-top: 5px;">
                  <li>é»æ“Šå³å´ <code>âš™ï¸</code> æŒ‰éˆ•é–‹å•Ÿç®¡ç†é¢æ¿ã€‚</li>
                  <li>è¼¸å…¥ã€Œæ›¸åº«åç¨±ã€ã€‚</li>
                  <li>é»æ“Šã€Œé¸æ“‡è³‡æ–™å¤¾ã€ä¸¦æˆæ¬Šç€è¦½å™¨å­˜å–ã€‚</li>
                  <li>é»æ“Šã€Œæ–°å¢æ›¸åº«ã€å®Œæˆè¨­å®šã€‚</li>
                </ul>
              </li>
            </ol>
          </section>

          <section style="margin-bottom: 20px;">
            <h3 style="color: var(--pri2); border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 10px;">ğŸ¯ æŠ½ç±¤èˆ‡ç·´ç¿’</h3>
            <ul style="padding-left: 20px;">
              <li><b>é–‹å§‹æŠ½ç±¤</b>ï¼šåœ¨ä¸»ç•«é¢é»æ“Šã€Œé–‹å§‹æŠ½ç±¤ã€æŒ‰éˆ•ã€‚</li>
              <li><b>æŸ¥çœ‹ç­”æ¡ˆ</b>ï¼šé»æ“Šã€Œé¡¯ç¤ºç­”æ¡ˆã€æˆ–æŒ‰å¿«æ·éµæŸ¥çœ‹åŸåœ–ã€‚</li>
              <li><b>æ¨™è¨˜çµæœ</b>ï¼šæ ¹æ“šä½œç­”æƒ…æ³é»æ“Šã€Œç­”å°ã€æˆ–ã€Œç­”éŒ¯ã€ï¼Œç³»çµ±æœƒè¨˜éŒ„åœ¨çµ±è¨ˆè¡¨èˆ‡æ­·å²æ¸…å–®ä¸­ã€‚</li>
            </ul>
          </section>

          <section style="margin-bottom: 20px;">
            <h3 style="color: var(--pri2); border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 10px;">âŒ¨ï¸ å¿«æ·éµæ”¯æ´</h3>
            <ul style="padding-left: 20px;">
              <li><b><code>ç©ºç™½éµ</code> / <code>Enter</code></b>ï¼šé–‹å§‹æŠ½ç±¤ / æŠ½ä¸‹ä¸€é¡Œ (ä¸¦è‡ªå‹•é—œé–‰ç­”æ¡ˆçª—)ã€‚</li>
              <li><b><code>A</code></b>ï¼šé¡¯ç¤ºç­”æ¡ˆè¦–çª—ã€‚</li>
              <li><b><code>Esc</code></b>ï¼šé—œé–‰ç­”æ¡ˆæˆ–ç¢ºèªè¦–çª—ã€‚</li>
              <li><b><code>1</code></b>ï¼šæ¨™è¨˜ç‚ºã€Œç­”å°ã€ã€‚</li>
              <li><b><code>2</code></b>ï¼šæ¨™è¨˜ç‚ºã€Œç­”éŒ¯ã€ã€‚</li>
            </ul>
          </section>

          <section style="margin-bottom: 20px;">
            <h3 style="color: var(--pri2); border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 10px;">ğŸ’¾ è³‡æ–™è¨˜æ†¶èˆ‡é™åˆ¶</h3>
            <ul style="padding-left: 20px;">
              <li><b>è‡ªå‹•å­˜æª”</b>ï¼šç¨‹å¼ä½¿ç”¨ç€è¦½å™¨çš„ <code>IndexedDB</code> å„²å­˜æŠ€è¡“ï¼Œæ‚¨çš„æ›¸åº«èˆ‡åœ–ç‰‡è³‡æ–™æœƒæ°¸ä¹…å„²å­˜åœ¨æ‚¨çš„é›»è…¦ä¸­ã€‚</li>
              <li><b>æ¶ˆå¤±é¢¨éšª</b>ï¼š
                <ul style="padding-left: 20px; margin-top: 5px;">
                  <li><b>æ›´æ›ç€è¦½å™¨</b>ï¼šä¸åŒç€è¦½å™¨ï¼ˆå¦‚ Chrome åˆ‡æ›åˆ° Edgeï¼‰è³‡æ–™ä¸äº’é€šã€‚</li>
                  <li><b>æ¸…é™¤å¿«å–</b>ï¼šè‹¥åŸ·è¡Œã€Œæ¸…é™¤ Cookie åŠç¶²ç«™è³‡æ–™ã€æ“ä½œï¼Œè³‡æ–™å°‡è¢«åˆªé™¤ã€‚</li>
                  <li><b>ç„¡ç—•æ¨¡å¼</b>ï¼šåœ¨ç„¡ç—•è¦–çª—ä¸­æ“ä½œï¼Œé—œé–‰å¾Œè³‡æ–™ä¸æœƒä¿ç•™ã€‚</li>
                </ul>
              </li>
            </ul>
          </section>
        </div>`,
        'æˆ‘æ˜ç™½äº†',
        false,
        null,
        true
      );
    }


    // ========== é¡¯ç¤ºç­”æ¡ˆ ==========
    function showAnswer() {
      if (!currentQuestion) return;

      const book = books[currentBook];
      const file = book.files.find(f => f.name === currentQuestion.name);

      showModal(
        'ğŸ‘€ ç­”æ¡ˆè¦–çª—',
        `<div class="modal-img-container">
          <img src="${file.dataUrl}" class="modal-img">
          <div style="margin-top:15px; font-size: 2rem; font-weight: 1000; color: #3b2b6a;">${currentQuestion.name}</div>
        </div>`,
        null,
        false
      );

      if (currentQuestion && currentBook && books[currentBook]) {
        const h = books[currentBook].history.find(x => x.name === currentQuestion.name);
        if (h) h.showedAnswer = true;
        updateHistory();
        saveData();
      }
    }


    // ========== æ¨™è¨˜ç­”å°/ç­”éŒ¯ ==========
    function markAnswer(state) {
      if (!currentQuestion || !currentBook || !books[currentBook]) return;
      const h = books[currentBook].history.find(x => x.name === currentQuestion.name);
      if (h) {
        h.state = state;
        updateStats();
        updateHistory();
        updateButtonStates();
        saveData();
        showToast(state === 'correct' ? 'âœ… å·²æ¨™è¨˜ç‚ºç­”å°' : 'âŒ å·²æ¨™è¨˜ç‚ºç­”éŒ¯');
      }
    }

    // ========== ä¸‹ä¸€é¡Œ ==========
    function nextQuestion() {
      const book = books[currentBook];
      const remaining = book.files.filter(f => !book.drawn.includes(f.name));
      if (remaining.length === 0) {
        showToast('æœ¬æ›¸åº«å·²å…¨éƒ¨æŠ½å®Œï¼');
        return;
      }
      drawQuestion();
    }

    // ========== é‡ç½®å–®ä¸€æ›¸åº« ==========
    function resetBook() {
      if (!currentBook || !books[currentBook]) return;

      showModal(
        'ğŸ”„ é‡ç½®æ›¸åº«',
        `ç¢ºå®šè¦é‡ç½®ã€Œ<b>${currentBook}</b>ã€çš„æŠ½ç±¤ç´€éŒ„å—ï¼Ÿ<br><br>æ­¤æ“ä½œæœƒæ¸…ç©ºè©²æ›¸åº«çš„æ‰€æœ‰æŠ½ç±¤æ­·å²ï¼Œä½†ä¿ç•™æ›¸åº«æœ¬èº«ã€‚`,
        'ç¢ºèªé‡ç½®',
        false,
        () => {
          books[currentBook].drawn = [];
          books[currentBook].history = [];
          currentQuestion = null;

          heroArea.style.display = 'flex';
          questionArea.style.display = 'none';

          updateStats();
          updateHistory();
          saveData();
          showToast('âœ… å·²é‡ç½®æ›¸åº«ã€Œ' + currentBook + 'ã€');
        }
      );
    }

    // ========== é‡ç½®æ‰€æœ‰æŠ½ç±¤ç´€éŒ„ï¼ˆä¿ç•™æ›¸åº«ï¼‰ ==========
    function resetAllRecords() {
      if (Object.keys(books).length === 0) {
        showToast('ç›®å‰æ²’æœ‰ä»»ä½•æ›¸åº«');
        return;
      }

      showModal(
        'ğŸ”„ é‡ç½®æ‰€æœ‰æŠ½ç±¤ç´€éŒ„',
        `ç¢ºå®šè¦é‡ç½®<b>æ‰€æœ‰æ›¸åº«</b>çš„æŠ½ç±¤ç´€éŒ„å—ï¼Ÿ<br><br>
        <b>å°‡æœƒæ¸…é™¤ï¼š</b><br>
        â€¢ æ‰€æœ‰æ›¸åº«çš„æŠ½ç±¤æ­·å²<br>
        â€¢ æ‰€æœ‰ç­”å°/ç­”éŒ¯ç´€éŒ„<br><br>
        <b>å°‡æœƒä¿ç•™ï¼š</b><br>
        â€¢ æ‰€æœ‰æ›¸åº«è¨­å®š<br>
        â€¢ æ³¨éŸ³å¿«å–è³‡æ–™`,
        'ç¢ºèªé‡ç½®',
        false,
        () => {
          for (const name of Object.keys(books)) {
            books[name].drawn = [];
            books[name].history = [];
          }
          currentQuestion = null;

          heroArea.style.display = 'flex';
          questionArea.style.display = 'none';

          updateStats();
          updateHistory();
          updateBookList();
          saveData();
          showToast('âœ… å·²é‡ç½®æ‰€æœ‰æ›¸åº«çš„æŠ½ç±¤ç´€éŒ„');
        }
      );
    }

    // ========== æ¸…ç©ºå…¨éƒ¨è³‡æ–™ ==========
    function resetAll() {
      showModal(
        'âš ï¸ æ¸…ç©ºå…¨éƒ¨è³‡æ–™',
        `<span style="color:#e24a4a;"><b>è­¦å‘Šï¼šæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼</b></span><br><br>
        ç¢ºå®šè¦æ¸…ç©ºå…¨éƒ¨è³‡æ–™å—ï¼Ÿ<br><br>
        <b>å°‡æœƒåˆªé™¤ï¼š</b><br>
        â€¢ æ‰€æœ‰æ›¸åº«<br>
        â€¢ æ‰€æœ‰æŠ½ç±¤ç´€éŒ„<br>
        â€¢ æ‰€æœ‰æ³¨éŸ³å¿«å–<br><br>
        æ¸…ç©ºå¾Œéœ€è¦é‡æ–°å»ºç«‹æ›¸åº«ä¸¦ç¶å®šè³‡æ–™å¤¾ã€‚`,
        'ç¢ºèªæ¸…ç©º',
        true,
        () => {
          books = {};
          currentBook = '';
          currentQuestion = null;
          zhuyinCache = {};
          selectedFiles = [];

          localStorage.removeItem('drawLots_books');
          localStorage.removeItem('drawLots_currentBook');
          localStorage.removeItem('drawLots_zhuyinCache');

          heroArea.style.display = 'flex';
          questionArea.style.display = 'none';
          heroHint.textContent = 'è«‹å…ˆåœ¨å³å´ã€Œå¾Œå°ç®¡ç†ã€æ–°å¢æ›¸åº«ä¸¦ç¶å®šè³‡æ–™å¤¾ã€‚';
          btnDraw.disabled = true;

          updateBookSelect();
          updateBookList();
          updateStats();
          updateHistory();

          showToast('âœ… å·²æ¸…ç©ºå…¨éƒ¨è³‡æ–™');
        }
      );
    }

    // ========== æ›´æ–°æ›¸åº«é¸å–® ==========
    function updateBookSelect() {
      selBook.innerHTML = '<option value="">-- è«‹é¸æ“‡æ›¸åº« --</option>';
      for (const name of Object.keys(books)) {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name + ` (${books[name].files.length} é¡Œ)`;
        selBook.appendChild(opt);
      }
      if (currentBook && books[currentBook]) {
        selBook.value = currentBook;
      }
    }

    // ========== æ›´æ–°æ›¸åº«åˆ—è¡¨ ==========
    function updateBookList() {
      if (Object.keys(books).length === 0) {
        bookList.innerHTML = '<div class="empty">å°šæœªå»ºç«‹ä»»ä½•æ›¸åº«</div>';
        return;
      }

      bookList.innerHTML = '';
      for (const [name, book] of Object.entries(books)) {
        const hasData = book.files.some(f => f.dataUrl);
        const drawnCount = book.drawn.length;
        const totalCount = book.files.length;
        const div = document.createElement('div');
        div.className = 'bookItem';
        div.innerHTML = `
          <div>
            <div class="name">${name}</div>
            <div class="info">${totalCount} é¡Œ | å·²æŠ½ ${drawnCount} é¡Œ | ${hasData ? 'âœ… å·²è¼‰å…¥' : 'âš ï¸ éœ€é‡æ–°ç¶å®š'}</div>
          </div>
          <div class="actions">
            <button class="btn small secondary rebind-btn" data-book="${name}">ğŸ“‚ é‡æ–°ç¶å®š</button>
            <button class="btn small danger delete-btn" data-book="${name}">ğŸ—‘ï¸</button>
          </div>
        `;
        bookList.appendChild(div);
      }

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = () => deleteBook(btn.dataset.book);
      });
      document.querySelectorAll('.rebind-btn').forEach(btn => {
        btn.onclick = () => rebindBook(btn.dataset.book);
      });
    }

    // ========== åˆªé™¤æ›¸åº« ==========
    function deleteBook(name) {
      showModal(
        'ğŸ—‘ï¸ åˆªé™¤æ›¸åº«',
        `ç¢ºå®šè¦åˆªé™¤ã€Œ<b>${name}</b>ã€æ›¸åº«å—ï¼Ÿ<br><br>æ­¤æ“ä½œæœƒåˆªé™¤è©²æ›¸åº«åŠå…¶æ‰€æœ‰æŠ½ç±¤ç´€éŒ„ã€‚`,
        'ç¢ºèªåˆªé™¤',
        true,
        () => {
          delete books[name];
          if (currentBook === name) {
            currentBook = '';
            currentQuestion = null;
            heroArea.style.display = 'flex';
            questionArea.style.display = 'none';
            heroHint.textContent = 'è«‹å…ˆé¸æ“‡æ›¸åº«';
            btnDraw.disabled = true;
          }
          updateBookSelect();
          updateBookList();
          updateStats();
          updateHistory();
          saveData();
          showToast('âœ… å·²åˆªé™¤æ›¸åº«ã€Œ' + name + 'ã€');
        }
      );
    }

    // ========== é‡æ–°ç¶å®šæ›¸åº« ==========
    async function rebindBook(name) {
      try {
        const dirHandle = await window.showDirectoryPicker();
        const files = [];
        const imageExts = ['.png', '.jpg', '.jpeg', '.webp', '.gif', '.bmp'];

        for await (const entry of dirHandle.values()) {
          if (entry.kind === 'file') {
            const lowerName = entry.name.toLowerCase();
            if (imageExts.some(ext => lowerName.endsWith(ext))) {
              const file = await entry.getFile();
              const dataUrl = await fileToDataUrl(file);
              const baseName = entry.name.replace(/\.[^.]+$/, '');
              files.push({ name: baseName, dataUrl });
            }
          }
        }

        if (files.length === 0) {
          showToast('è³‡æ–™å¤¾å…§æ²’æœ‰åœ–ç‰‡æª”æ¡ˆ');
          return;
        }

        const oldHistory = books[name].history;
        const oldDrawn = books[name].drawn;

        books[name].files = files;
        const newNames = files.map(f => f.name);
        books[name].drawn = oldDrawn.filter(n => newNames.includes(n));
        books[name].history = oldHistory.filter(h => newNames.includes(h.name));

        updateBookList();
        updateBookSelect();
        updateStats();
        updateHistory();
        saveData();
        showToast(`âœ… å·²é‡æ–°ç¶å®šã€Œ${name}ã€ï¼Œå…± ${files.length} é¡Œ`);

      } catch (e) {
        if (e.name !== 'AbortError') {
          console.error('é‡æ–°ç¶å®šå¤±æ•—', e);
          showToast('âŒ é‡æ–°ç¶å®šå¤±æ•—');
        }
      }
    }

    // ========== é¸æ“‡è³‡æ–™å¤¾ ==========
    async function selectFolder() {
      try {
        const dirHandle = await window.showDirectoryPicker();
        const files = [];
        const imageExts = ['.png', '.jpg', '.jpeg', '.webp', '.gif', '.bmp'];

        for await (const entry of dirHandle.values()) {
          if (entry.kind === 'file') {
            const lowerName = entry.name.toLowerCase();
            if (imageExts.some(ext => lowerName.endsWith(ext))) {
              const file = await entry.getFile();
              const dataUrl = await fileToDataUrl(file);
              const baseName = entry.name.replace(/\.[^.]+$/, '');
              files.push({ name: baseName, dataUrl });
            }
          }
        }

        if (files.length === 0) {
          folderHint.textContent = 'âš ï¸ è³‡æ–™å¤¾å…§æ²’æœ‰åœ–ç‰‡æª”æ¡ˆ';
          selectedFiles = [];
          btnAddBook.disabled = true;
          return;
        }

        selectedFiles = files;
        folderHint.textContent = `âœ… å·²æƒæåˆ° ${files.length} å¼µåœ–ç‰‡`;
        btnAddBook.disabled = !inputBookName.value.trim();

      } catch (e) {
        if (e.name !== 'AbortError') {
          console.error('é¸æ“‡è³‡æ–™å¤¾å¤±æ•—', e);
          showToast('âŒ é¸æ“‡è³‡æ–™å¤¾å¤±æ•—');
        }
      }
    }

    // ========== æª”æ¡ˆè½‰ DataURL ==========
    function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ========== æ–°å¢æ›¸åº« ==========
    function addBook() {
      const name = inputBookName.value.trim();
      if (!name) {
        showToast('è«‹è¼¸å…¥æ›¸åº«åç¨±');
        return;
      }
      if (books[name]) {
        showToast('æ›¸åº«åç¨±å·²å­˜åœ¨');
        return;
      }
      if (selectedFiles.length === 0) {
        showToast('è«‹å…ˆé¸æ“‡è³‡æ–™å¤¾');
        return;
      }

      books[name] = {
        files: [...selectedFiles],
        drawn: [],
        history: []
      };

      currentBook = name;

      inputBookName.value = '';
      folderHint.textContent = 'å°šæœªé¸æ“‡è³‡æ–™å¤¾';
      selectedFiles = [];
      btnAddBook.disabled = true;

      updateBookSelect();
      updateBookList();
      updateStats();
      updateHistory();
      saveData();

      heroArea.style.display = 'flex';
      questionArea.style.display = 'none';
      heroHint.textContent = `å·²å»ºç«‹ã€Œ${name}ã€ï¼Œå…± ${books[name].files.length} é¡Œï¼Œå¯ä»¥é–‹å§‹æŠ½ç±¤ï¼`;
      btnDraw.disabled = false;

      showToast(`âœ… å·²æ–°å¢æ›¸åº«ã€Œ${name}ã€`);

      // é æŠ“æ³¨éŸ³
      prefetchZhuyin(name);
    }

    // ========== åˆ‡æ›æ›¸åº« ==========
    function switchBook() {
      const name = selBook.value;
      if (!name) {
        currentBook = '';
        btnDraw.disabled = true;
        heroHint.textContent = 'è«‹å…ˆé¸æ“‡æ›¸åº«';
        heroArea.style.display = 'flex';
        questionArea.style.display = 'none';
        updateStats();
        updateHistory();
        return;
      }

      currentBook = name;
      const book = books[name];
      const hasData = book.files.some(f => f.dataUrl);

      if (!hasData) {
        btnDraw.disabled = true;
        heroHint.textContent = 'âš ï¸ æ­¤æ›¸åº«éœ€è¦é‡æ–°ç¶å®šè³‡æ–™å¤¾æ‰èƒ½ä½¿ç”¨';
      } else {
        btnDraw.disabled = false;
        const remaining = book.files.length - book.drawn.length;
        heroHint.textContent = `ã€Œ${name}ã€å…± ${book.files.length} é¡Œï¼Œå‰©é¤˜ ${remaining} é¡Œ`;
      }

      heroArea.style.display = 'flex';
      questionArea.style.display = 'none';
      currentQuestion = null;

      updateStats();
      updateHistory();
      saveData();
    }

    async function init() {
      await loadData();
      updateBookSelect();
      updateBookList();
      updateStats();
      updateHistory();

      if (currentBook && books[currentBook]) {
        selBook.value = currentBook;
        const book = books[currentBook];
        const hasData = book.files.some(f => f.dataUrl);
        if (hasData) {
          btnDraw.disabled = false;
          const remaining = book.files.length - book.drawn.length;
          heroHint.textContent = `ã€Œ${currentBook}ã€å…± ${book.files.length} é¡Œï¼Œå‰©é¤˜ ${remaining} é¡Œ`;
        } else {
          heroHint.textContent = 'âš ï¸ æ­¤æ›¸åº«éœ€è¦é‡æ–°ç¶å®šè³‡æ–™å¤¾æ‰èƒ½ä½¿ç”¨';
        }
      }

      // äº‹ä»¶ç¶å®š
      btnDraw.onclick = animateDraw;
      btnDrawNext.onclick = animateDraw;
      btnShowAns.onclick = showAnswer;
      btnCorrect.onclick = () => markAnswer('correct');
      btnWrong.onclick = () => markAnswer('wrong');
      btnReset.onclick = resetBook;
      btnSelectFolder.onclick = selectFolder;
      btnAddBook.onclick = addBook;
      btnHelp.onclick = showHelp;
      selBook.onchange = switchBook;
      btnResetAllRecords.onclick = resetAllRecords;
      btnResetAll.onclick = resetAll;

      modalClose.onclick = hideModal;
      modalOverlay.onclick = (e) => {
        if (e.target === modalOverlay) hideModal();
      };

      btnToggleSidebar.onclick = () => {
        sidebar.classList.toggle('open');
        sidebarOverlay.classList.toggle('show');
      };
      sidebarOverlay.onclick = () => {
        sidebar.classList.remove('open');
        sidebarOverlay.classList.remove('show');
      };

      inputBookName.oninput = () => {
        btnAddBook.disabled = !inputBookName.value.trim() || selectedFiles.length === 0;
      };

      // æ­·å²ç¯©é¸
      document.querySelectorAll('.tab').forEach(tab => {
        tab.onclick = () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          historyFilter = tab.dataset.filter;
          updateHistory();
        };
      });

      // å¿«æ·éµ
      window.addEventListener('keydown', (e) => {
        // å¦‚æœæ­£åœ¨è¼¸å…¥æ–‡å­—ï¼Œä¸è§¸ç™¼å¿«æ·éµ
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;

        if (e.code === 'Space' || e.code === 'Enter') {
          e.preventDefault();
          if (questionArea.style.display === 'block') {
            animateDraw();
          } else if (btnDraw.disabled === false) {
            animateDraw();
          }
        } else if (e.key === '1') {
          if (questionArea.style.display === 'block' && !btnCorrect.disabled) markAnswer('correct');
        } else if (e.key === '2') {
          if (questionArea.style.display === 'block' && !btnWrong.disabled) markAnswer('wrong');
        } else if (e.key.toLowerCase() === 'a') {
          if (questionArea.style.display === 'block') showAnswer();
        } else if (e.key === 'Escape') {
          hideModal();
        }
      });

      // ğŸ”Š éŸ³æ•ˆè§£é–ï¼šæŸäº›ç€è¦½å™¨ï¼ˆå°¤å…¶æ˜¯æœ¬åœ°æ¸¬è©¦ï¼‰éœ€è¦ä½¿ç”¨è€…é»æ“Šé é¢å¾Œæ‰å…è¨±æ’­æ”¾éŸ³æ•ˆ
      const unlockAudio = () => {
        const audioEl = document.getElementById('audioDraw');
        if (audioEl) {
          audioEl.play().then(() => {
            audioEl.pause();
            audioEl.currentTime = 0;
          }).catch(() => { });
          window.removeEventListener('click', unlockAudio);
          window.removeEventListener('keydown', unlockAudio);
        }
      };
      window.addEventListener('click', unlockAudio);
      window.addEventListener('keydown', unlockAudio);
    }


    // æª¢æŸ¥ File System Access API æ”¯æ´
    if (!window.showDirectoryPicker) {
      document.body.innerHTML = `
        <div style="padding: 40px; text-align: center;">
          <h2>âš ï¸ ç€è¦½å™¨ä¸æ”¯æ´</h2>
          <p>æ­¤æ‡‰ç”¨éœ€è¦ File System Access APIï¼Œè«‹ä½¿ç”¨ <b>Chrome</b> æˆ– <b>Edge</b> ç€è¦½å™¨é–‹å•Ÿã€‚</p>
        </div>
      `;
    } else {
      init();
    }
  </script>
  <footer
    style="text-align: center; padding: 20px; font-size: 13px; color: var(--muted); opacity: 0.8; font-weight: 700;">
    ç¨‹å¼ä½œè€…ï¼šå¾æ‰¿ä½‘
  </footer>
  <!-- é è¼‰éŸ³æ•ˆ -->
  <audio id="audioDraw" preload="auto">
    <source src="music.mp3" type="audio/mpeg">
  </audio>
</body>

</html>
